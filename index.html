<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ’ª Cheer Workout Timer</title>
<style>
:root { font-size: clamp(14px, 4vw, 20px); }
html { touch-action: manipulation; }
body{
  font-family:"Hiragino Sans","Yu Gothic",system-ui,-apple-system,sans-serif;
  margin:0; padding:min(5vw, 1rem); min-height:100vh;
  background:linear-gradient(135deg,#ffeef8 0%,#f0f8ff 50%,#fff0f8 100%);
  color:#5a4b7a; box-sizing:border-box;
  overflow-x: hidden; /* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
}
.container{
  max-width: min(calc(100vw - 2rem), 28rem); 
  width: 100%; 
  margin: 0 auto; 
  padding: min(4vw, 1.25rem);
  background: rgba(255,255,255,.9); 
  border-radius: min(3vw, 1.25rem);
  box-shadow: 0 0.5rem 2rem rgba(0,0,0,.1);
  box-sizing: border-box;
}

h1{
  font-size: 1.6rem; margin-bottom: .75rem; text-align:center; font-weight:bold;
  color:#ff6b9d;
}

.row{ margin: 1rem 0; display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; justify-content:center; }
label{ font-weight:bold; color:#8b7aa8; font-size:1rem; }
input[type="number"]{
  width: 4.2rem; padding:.6rem; font-size:1rem; border: .125rem solid #ffc1e3; border-radius: 1rem;
  background: rgba(255,255,255,.85); text-align:center; color:#5a4b7a; font-weight:bold;
}

button{
  padding:min(3vw, .8rem) min(4vw, 1.1rem); border:none; border-radius:min(3vw, 1.1rem); 
  background:linear-gradient(45deg,#ff6b9d,#ff8fab);
  color:#fff; font-size:1rem; font-weight:bold; cursor:pointer;
  min-height: 44px; touch-action: manipulation;
  position: relative; z-index: 10;
}
button:hover, button:active{ transform:translateY(-.15rem); }
#stopBtn{ background:linear-gradient(45deg,#a8a8a8,#c0c0c0); }

#status{
  margin-top:1rem; font-size:1.2rem; text-align:center; font-weight:bold; color:#ff6b9d;
  padding:.8rem; background:rgba(255,193,227,.1); border-radius:1rem;
}
#msg{
  margin-top: .8rem; font-size:1rem; min-height:2em; text-align:center;
  padding:.75rem; border-radius:1rem; color:#8b7aa8; font-weight:bold;
}
</style>
</head>
<body>
<div class="container">
  <h1>ğŸ’ª Cheer Workout Timer</h1>

  <div class="row">
    <label>ã‚»ãƒƒãƒˆ <input id="sets" type="number" value="8" min="1" /></label>
    <label>ä½œæ¥­(ç§’) <input id="work" type="number" value="45" min="5" /></label>
    <label>ä¼‘æ†©(ç§’) <input id="rest" type="number" value="15" min="0" /></label>
  </div>

  <div class="row">
    <button id="startBtn">ğŸŒŸ Start</button>
    <button id="stopBtn">â¸ï¸ Stop</button>
  </div>

  <div id="status">ğŸ’¤ Stopped</div>
  <div id="msg">â€¦</div>
</div>

<script>
// éŸ³å£°ãƒªã‚¹ãƒˆ
const AUDIO_FILES = [
  { file: 'audio/ganbare.mp3', text: 'ãŒã‚“ã°ã‚Œãƒ¼ï¼' },
  { file: 'audio/ganbatte.mp3', text: 'é ‘å¼µã£ã¦ï¼' }, 
  { file: 'audio/sono_choshi.mp3', text: 'ãã®èª¿å­ãã®èª¿å­ï¼' },
  { file: 'audio/hurray.mp3', text: 'ãƒ•ãƒ¬ãƒ¼ãƒ•ãƒ¬ãƒ¼ï¼' }
];

const REST_AUDIO = { file: 'audio/ato_chotto.mp3', text: 'ã‚ã¨ã¡ã‚‡ã£ã¨ã€œï¼' };

const COMPLETE_FILES = [
  { file: 'audio/yatta_ne.mp3', text: 'ã‚„ã£ãŸã­ï¼' },
  { file: 'audio/yatta_long.mp3', text: 'ã‚„ã£ãŸãƒ¼ãƒ¼ï¼' },
  { file: 'audio/otsukaresama.mp3', text: 'ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼' }
];

// ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
function pick(arr){ return arr[Math.floor(Math.random() * arr.length)]; }

// iOSå¯¾ç­–ï¼šå˜ä¸€ã®Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã„å›ã—
let globalAudio = null;
let audioUnlocked = false;

// éŸ³å£°è§£æ”¾ï¼ˆiOSå¯¾ç­–ï¼‰
function unlockAudio() {
  if (audioUnlocked) return Promise.resolve();
  
  return new Promise((resolve) => {
    globalAudio = new Audio();
    globalAudio.volume = 0.7;
    globalAudio.src = 'audio/ganbare.mp3';
    
    globalAudio.play().then(() => {
      console.log('Audio unlocked');
      audioUnlocked = true;
      // ç„¡éŸ³ã§åœæ­¢
      globalAudio.pause();
      globalAudio.currentTime = 0;
      resolve();
    }).catch(() => {
      console.log('Audio blocked');
      resolve();
    });
  });
}

// ã‚·ãƒ³ãƒ—ãƒ«ãªéŸ³å£°å†ç”Ÿï¼ˆå˜ä¸€Audioã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½¿ç”¨ï¼‰
function playAudio(audioEntry) {
  try {
    console.log('Playing:', audioEntry.file, audioEntry.text);
    
    if (!globalAudio) {
      console.log('Audio not unlocked yet');
      document.getElementById('msg').textContent = audioEntry.text;
      return;
    }
    
    // å‰ã®éŸ³å£°ã‚’åœæ­¢ã—ã¦ã‹ã‚‰æ–°ã—ã„éŸ³å£°ã‚’ã‚»ãƒƒãƒˆ
    globalAudio.pause();
    globalAudio.currentTime = 0;
    globalAudio.src = audioEntry.file;
    
    globalAudio.play().catch(e => console.log('Audio failed:', audioEntry.file, e));
    document.getElementById('msg').textContent = audioEntry.text;
  } catch (e) {
    console.log('Audio error:', audioEntry.file, e);
    document.getElementById('msg').textContent = audioEntry.text;
  }
}

// ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½
let running = false;
let currentTimeout = null;

function sleep(ms) { 
  return new Promise((resolve, reject) => { 
    currentTimeout = setTimeout(() => {
      currentTimeout = null;
      resolve();
    }, ms);
  }); 
}

function stopWorkout() {
  console.log('Stopping workout...');
  running = false;
  
  // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
  if (currentTimeout) {
    clearTimeout(currentTimeout);
    currentTimeout = null;
  }
  
  // éŸ³å£°ã‚’åœæ­¢
  if (globalAudio) {
    globalAudio.pause();
    globalAudio.currentTime = 0;
  }
  
  // UIã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('status').textContent = 'ğŸ’¤ Stopped';
  document.getElementById('msg').textContent = 'â€¦';
  
  console.log('Workout stopped');
}

async function run() {
  if (running) return;
  
  running = true;
  console.log('Starting workout...');
  
  const sets = parseInt(document.getElementById('sets').value, 10);
  const work = parseInt(document.getElementById('work').value, 10);
  const rest = parseInt(document.getElementById('rest').value, 10);

  try {
    for (let i = 1; i <= sets && running; i++) {
      // ã‚¹ãƒˆãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
      if (!running) {
        console.log('Workout stopped during setup');
        break;
      }
      
      // ã‚»ãƒƒãƒˆé–‹å§‹
      document.getElementById('status').textContent = `ğŸ’ª Set ${i}/${sets} - WORK`;
      
      const workEntry = pick(AUDIO_FILES);
      playAudio(workEntry);
      
      // ä½œæ¥­æ™‚é–“å¾…æ©Ÿ
      await sleep(work * 1000);
      
      // ã‚¹ãƒˆãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
      if (!running) {
        console.log('Workout stopped during work');
        break;
      }

      // ä¼‘æ†©
      if (i < sets && rest > 0 && running) {
        document.getElementById('status').textContent = `ğŸ˜Œ Rest (${rest}s)`;
        playAudio(REST_AUDIO);
        
        // ä¼‘æ†©æ™‚é–“å¾…æ©Ÿ
        await sleep(rest * 1000);
        
        // ã‚¹ãƒˆãƒƒãƒ—ãƒã‚§ãƒƒã‚¯
        if (!running) {
          console.log('Workout stopped during rest');
          break;
        }
      }
    }

    // å®Œäº†å‡¦ç†ï¼ˆåœæ­¢ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
    if (running) {
      document.getElementById('status').textContent = 'ğŸ‰ Complete!';
      const completeEntry = pick(COMPLETE_FILES);
      playAudio(completeEntry);
    }
  } catch (error) {
    console.log('Workout error:', error);
  } finally {
    running = false;
    console.log('Workout ended');
  }
}

// iOSå¯¾ç­–ï¼šã‚¯ãƒªãƒƒã‚¯æ™‚ã«å³åº§ã«éŸ³å£°è§£æ”¾
document.getElementById('startBtn').addEventListener('click', async (e) => {
  e.preventDefault();
  
  if (!running) {
    // iOSå¯¾ç­–ï¼šéŸ³å£°è§£æ”¾
    await unlockAudio();
    
    // éŸ³å£°è§£æ”¾æˆåŠŸå¾Œã«ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆé–‹å§‹ï¼ˆç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚å°‘ã—å¾…ã¤ï¼‰
    setTimeout(() => {
      if (audioUnlocked) {
        console.log('Starting workout with audio enabled');
      } else {
        console.log('Starting workout without audio');
      }
      run();
    }, 500);
  }
});

// ã‚¹ãƒˆãƒƒãƒ—ãƒœã‚¿ãƒ³ï¼ˆè¤‡æ•°ã‚¤ãƒ™ãƒ³ãƒˆã§ç¢ºå®Ÿã«ï¼‰
document.getElementById('stopBtn').addEventListener('click', (e) => {
  e.preventDefault();
  console.log('Stop button clicked');
  stopWorkout();
});

document.getElementById('stopBtn').addEventListener('touchstart', (e) => {
  e.preventDefault();
  console.log('Stop button touched');
  stopWorkout();
}, {passive: false});
</script>
</body>
</html>